{% comment %}
  Upsell Popup - Shows after adding a trigger product to cart
  Displays recommended nail sets with $10 OFF badges
{% endcomment %}

{% if settings.enable_upsell_offer and settings.enable_upsell_popup %}
  {% assign upsell_tag = settings.upsell_product_tag | default: 'upsell-trigger' | downcase %}
  {% assign upsell_collection = settings.upsell_popup_collection %}
  {% assign popup_products = upsell_collection.products | default: settings.collection_cross_sells.products %}
  
  <div id="upsell-popup-overlay" class="upsell-popup-overlay" data-upsell-overlay></div>
  
  <div id="upsell-popup" class="upsell-popup" data-upsell-popup data-upsell-tag="{{ upsell_tag }}">
    <div class="upsell-popup__header">
      <button type="button" class="upsell-popup__close" data-upsell-close aria-label="Close">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      <span class="upsell-popup__icon">{{ settings.upsell_icon | default: 'üéÅ' }}</span>
      <h2 class="upsell-popup__title">{{ settings.upsell_popup_title | default: 'Unlock Your $10 Discount!' }}</h2>
      <p class="upsell-popup__subtitle">{{ settings.upsell_popup_subtitle | default: 'Add another nail set to save $10' }}</p>
    </div>
    
    <div class="upsell-popup__body">
      <div class="upsell-popup__products">
        {% assign shown_count = 0 %}
        {% for product in popup_products limit: 6 %}
          {% assign product_is_eligible = false %}
          {% for tag in product.tags %}
            {% assign tag_downcase = tag | downcase %}
            {% if tag_downcase == upsell_tag %}
              {% assign product_is_eligible = true %}
              {% break %}
            {% endif %}
          {% endfor %}
          
          {% if product_is_eligible and shown_count < 3 %}
            {% assign shown_count = shown_count | plus: 1 %}
            <div class="upsell-popup__product" data-product-id="{{ product.id }}">
              <span class="upsell-popup__product-badge">{{ settings.upsell_badge_text | default: '$10 OFF' }}</span>
              
              <img 
                src="{{ product.featured_image | image_url: width: 160 }}" 
                alt="{{ product.featured_image.alt | escape }}"
                class="upsell-popup__product-image"
                width="80"
                height="80"
                loading="lazy"
              >
              
              <div class="upsell-popup__product-info">
                <h3 class="upsell-popup__product-title">{{ product.title }}</h3>
                <p class="upsell-popup__product-price">{{ product.price | money }}</p>
                
                {% if product.available %}
                  <button 
                    type="button" 
                    class="upsell-popup__product-add"
                    data-upsell-add
                    data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                    data-product-title="{{ product.title | escape }}"
                  >
                    Add to Cart
                  </button>
                {% else %}
                  <button type="button" class="upsell-popup__product-add" disabled>
                    Sold Out
                  </button>
                {% endif %}
              </div>
            </div>
          {% endif %}
        {% endfor %}
        
        {% comment %} Fallback if no products found {% endcomment %}
        {% if shown_count == 0 %}
          <p style="text-align: center; color: #888; padding: 20px;">
            Check out our <a href="/collections/all" style="color: #ff9cb5;">nail sets collection</a> to find your perfect match!
          </p>
        {% endif %}
      </div>
    </div>
    
    <div class="upsell-popup__footer">
      <button type="button" class="upsell-popup__skip" data-upsell-close>
        No thanks, continue shopping
      </button>
    </div>
  </div>
  
  <script>
    // Pass upsell trigger tag to JavaScript
    window.SIYOU_UPSELL = window.SIYOU_UPSELL || {};
    window.SIYOU_UPSELL.triggerTag = '{{ upsell_tag }}';
    window.SIYOU_UPSELL.enabled = true;
  </script>
{% endif %}

