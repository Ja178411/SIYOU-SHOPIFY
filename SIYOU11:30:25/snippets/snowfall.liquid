{%- comment -%}
  Snowfall Animation Overlay
  A lightweight, performant snowfall effect for holiday theming.
  Controlled via Theme Settings > Holiday Mode

  Usage: {% render 'snowfall', container_id: 'unique-id' %}
  - Renders inside the parent element (hero section)
  - Parent must have position: relative and overflow: hidden
{%- endcomment -%}

{%- if settings.enable_snowfall -%}
{%- assign snowfall_id = container_id | default: section.id | default: 'hero' -%}

<style id="snowfall-styles-{{ snowfall_id }}">
  /* Parent container styling */
  .snowfall-parent {
    position: relative;
    overflow: hidden;
  }

  .snowfall-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10;
    overflow: hidden;
  }

  .snowflake {
    position: absolute;
    top: -20px;
    color: {{ settings.snowflake_color | default: '#ffffff' }};
    opacity: 0;
    pointer-events: none;
    user-select: none;
    text-shadow: 0 0 3px rgba(255,255,255,0.5);
    will-change: transform, opacity;
    animation: snowfall-drift linear forwards;
  }

  @keyframes snowfall-drift {
    0% {
      opacity: 0;
      transform: translateY(0) translateX(0) rotate(0deg);
    }
    10% {
      opacity: 0.9;
    }
    90% {
      opacity: 0.7;
    }
    100% {
      opacity: 0;
      transform: translateY(calc(100% + 50px)) translateX(var(--drift-x, 20px)) rotate(var(--rotation, 360deg));
    }
  }

  /* Reduce motion for accessibility */
  @media (prefers-reduced-motion: reduce) {
    .snowfall-container {
      display: none;
    }
  }

  /* Slightly reduce on mobile for performance */
  @media (max-width: 480px) {
    .snowfall-container {
      opacity: 0.7;
    }
  }
</style>

<div class="snowfall-container" id="snowfall-{{ snowfall_id }}" aria-hidden="true"></div>

<script id="snowfall-script-{{ snowfall_id }}">
(function() {
  'use strict';

  const container = document.getElementById('snowfall-{{ snowfall_id }}');
  if (!container) return;

  // Add snowfall-parent class to immediate parent for proper positioning
  if (container.parentElement) {
    container.parentElement.classList.add('snowfall-parent');
  }

  const config = {
    intensity: {{ settings.snowfall_intensity | default: 30 }},
    style: '{{ settings.snowflake_style | default: "mixed" }}',
    color: '{{ settings.snowflake_color | default: "#ffffff" }}'
  };

  const flakeChars = {
    dots: ['•', '·', '●'],
    flakes: ['❄', '❅', '❆', '✻', '✼'],
    mixed: ['•', '·', '❄', '❅', '●', '✻']
  };

  const chars = flakeChars[config.style] || flakeChars.mixed;
  let activeFlakes = 0;
  const maxFlakes = config.intensity;

  function createSnowflake() {
    if (activeFlakes >= maxFlakes) return;

    const flake = document.createElement('span');
    flake.className = 'snowflake';
    flake.textContent = chars[Math.floor(Math.random() * chars.length)];

    // Random positioning and animation properties
    const startX = Math.random() * 100;
    const size = Math.random() * 18 + 14; // 14–32px (bigger, more visible)
    const containerHeight = container.offsetHeight || 600;
    // Much faster, height-aware fall speed. Clamp height factor so tall heroes
    // don’t slow flakes too much.
    const heightFactor = Math.min(containerHeight / 500, 1); // ~0.6–1x
    const duration = (Math.random() * 1.5 + 2.0) * heightFactor; // ~2–3.5s
    const driftX = (Math.random() - 0.5) * 100; // -50 to 50px horizontal drift
    const rotation = Math.random() * 720 - 360;
    const delay = Math.random() * 1.5;

    flake.style.cssText = `
      left: ${startX}%;
      font-size: ${size}px;
      animation-duration: ${duration}s;
      animation-delay: ${delay}s;
      --drift-x: ${driftX}px;
      --rotation: ${rotation}deg;
    `;

    container.appendChild(flake);
    activeFlakes++;

    // Remove flake after animation completes
    const totalTime = (duration + delay) * 1000;
    setTimeout(() => {
      if (flake.parentNode) {
        flake.remove();
        activeFlakes--;
      }
    }, totalTime + 100);
  }

    // Create snowflakes at intervals
  function startSnowfall() {
    // Initial burst
      for (let i = 0; i < Math.min(14, maxFlakes); i++) {
        setTimeout(createSnowflake, i * 80);
    }

    // Continuous snowfall
      const interval = Math.max(80, 2200 / maxFlakes); // spawn faster overall
    setInterval(createSnowflake, interval);
  }

  // Start after a small delay to not block hero rendering
  if (document.readyState === 'complete') {
    setTimeout(startSnowfall, 100);
  } else {
    window.addEventListener('load', () => setTimeout(startSnowfall, 100));
  }

  // Pause animation when tab is not visible (performance)
  document.addEventListener('visibilitychange', () => {
    container.style.display = document.hidden ? 'none' : '';
  });
})();
</script>
{%- endif -%}

