{{ 'section-shoppable-video.css' | asset_url | stylesheet_tag }}
{{ 'shoppable-image.css' | asset_url | stylesheet_tag }}

{% assign line_items_ids = '' %}
{% for line_item in cart.items %}
  {% assign line_items_ids = line_items_ids | append: line_item.product_id | append: ', ' %}
{% endfor %}

{% comment %}
  Winter Promo Detection:
  - Winter sets (Sweet Snowflake, Winter Stars Glow) have "upsell-trigger" tag
  - Any nail set has "nail-set" tag
  - Promo: Buy a winter set → get $10 off ANY other nail set
{% endcomment %}
{% assign cart_has_winter_set = false %}
{% assign cart_has_other_nail_set = false %}
{% assign winter_set_count = 0 %}
{% assign other_nail_set_count = 0 %}
{% assign upsell_tag = settings.upsell_product_tag | default: 'upsell-trigger' | downcase %}

{% assign total_nail_sets_in_cart = 0 %}

{% for item in cart.items %}
  {% assign is_winter_set = false %}
  {% assign is_nail_set = false %}

  {% for tag in item.product.tags %}
    {% assign tag_downcase = tag | downcase %}
    {% if tag_downcase == upsell_tag %}
      {% assign is_winter_set = true %}
    {% endif %}
    {% comment %} Check for both "nail-set" and "nail sets" tag formats {% endcomment %}
    {% if tag_downcase == 'nail-set' or tag_downcase == 'nail sets' or tag_downcase == 'nail set' %}
      {% assign is_nail_set = true %}
    {% endif %}
  {% endfor %}

  {% if is_winter_set %}
    {% assign cart_has_winter_set = true %}
    {% assign winter_set_count = winter_set_count | plus: item.quantity %}
  {% endif %}
  
  {% comment %} Count ALL nail sets (including winter sets) {% endcomment %}
  {% if is_nail_set %}
    {% assign total_nail_sets_in_cart = total_nail_sets_in_cart | plus: item.quantity %}
  {% endif %}
  
  {% comment %} Track non-winter nail sets separately {% endcomment %}
  {% if is_nail_set and is_winter_set == false %}
    {% assign cart_has_other_nail_set = true %}
    {% assign other_nail_set_count = other_nail_set_count | plus: item.quantity %}
  {% endif %}
{% endfor %}

{% comment %} For backward compatibility {% endcomment %}
{% assign cart_has_nail_set = cart_has_winter_set %}

{% comment %} 
  Discount is unlocked when:
  - Cart has at least 1 winter set AND at least 1 other nail set (any type)
  - OR cart has 2+ winter sets (buying 2 winter sets also qualifies)
{% endcomment %}
{% assign discount_unlocked = false %}
{% if cart_has_winter_set and cart_has_other_nail_set %}
  {% assign discount_unlocked = true %}
{% elsif cart_has_winter_set and winter_set_count >= 2 %}
  {% comment %} 2+ winter sets also unlocks the discount {% endcomment %}
  {% assign discount_unlocked = true %}
{% endif %}

{% assign limit_products = settings.product_limit_cross_sells %}

{% assign hide_brand = true %}
{% if settings.show_vendor %}
  {% assign hide_brand = false %}
{% endif %}

{% comment %} default value is collection {% endcomment %}
{% assign cross_sell_products = settings.collection_cross_sells.products %}
{% assign cross_sell_size = 0 %}

{% assign product_source = settings.product_source_cross_sells %}

{% if product_source == 'product_list' %}
  {% assign cross_sell_products = settings.product_list_cross_sells %}
{% endif %}

{% for cs_product in cross_sell_products %}
  {% unless line_items_ids contains cs_product.id %}
    {% assign cross_sell_size = cross_sell_size | plus: 1 %}
  {% endunless %}
{% endfor %}

{% if cross_sell_size == 0 %}
  {% if request.design_mode %}
    <div class="wt-cart__cross-sell wt-cart__cross-sell--empty">
      <p class="wt-cart__cross-sell__heading">
        {{ settings.heading_cross_sells }}
      </p>
      <p class="wt-cart__cross-sell__empty">{{ 'cross_sell.empty_msg' | t }}</p>
    </div>
  {% endif %}
{% else %}
  <div class="wt-cart__cross-sell {% if settings.cross_sells_collapsed %}wt-cart__cross-sell--collapsed{% endif %}">
    <p class="wt-cart__cross-sell__heading">
      {{ settings.heading_cross_sells }}
      <span
        class="wt-cart__cross-sell__toggle"
        onclick="this.closest('.wt-cart__cross-sell').classList.toggle('wt-cart__cross-sell--collapsed')"
      >
        {% render 'icons', id: 'arrow-down' %}
      </span>
    </p>

    {% comment %}
      Winter Promo Banner - shows when winter set is in cart
      Two states:
      1. Winter set in cart, no other nail set → Step 1 of 2 complete
      2. Winter set + another nail set → Both steps complete, $10 saved
    {% endcomment %}
    {% if settings.enable_upsell_offer and cart_has_winter_set %}
      <div class="upsell-banner {% if discount_unlocked %}upsell-banner--success{% endif %}">
        <div class="upsell-banner__content">
          {% if discount_unlocked %}
            <div class="upsell-banner__header">
              <div class="upsell-banner__step-indicator">
                <span class="upsell-banner__step upsell-banner__step--complete">✓</span>
                <span class="upsell-banner__step-line" style="background: rgba(255, 255, 255, 0.8);"></span>
                <span class="upsell-banner__step upsell-banner__step--complete">✓</span>
              </div>
              <div class="upsell-banner__text">
                <h4 class="upsell-banner__title">You're Saving $10!</h4>
                <p class="upsell-banner__subtitle">Discount applies automatically at checkout</p>
              </div>
            </div>
          {% else %}
            <div class="upsell-banner__header">
              <div class="upsell-banner__step-indicator">
                <span class="upsell-banner__step upsell-banner__step--complete">✓</span>
                <span class="upsell-banner__step-line"></span>
                <span class="upsell-banner__step upsell-banner__step--pending">2</span>
              </div>
              <div class="upsell-banner__text">
                <h4 class="upsell-banner__title">Step 1 of 2 Complete!</h4>
                <p class="upsell-banner__subtitle">Add any nail set below to save $10</p>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    {% endif %}

    <div class="wt-cart__cross-sell__products">
      {% if cross_sell_size > 1 %}
        <script type="module" src="{{ 'slider.js' | asset_url }}" defer="defer"></script>
        <slideshow-section class="wt-slider wt-slider--cross-sell" data-skip-center-nav-method="true">
          <div data-swiper class="wt-slider__container" data-sound="off">
            <div data-swiper-container class="video-reels__container">
              {% for cs_product in cross_sell_products limit: limit_products %}
                {% comment %} Check if this product is a nail set (eligible for $10 off) {% endcomment %}
                {% assign product_is_nail_set = false %}
                {% for tag in cs_product.tags %}
                  {% assign tag_downcase = tag | downcase %}
                  {% if tag_downcase == 'nail-set' or tag_downcase == 'nail sets' or tag_downcase == 'nail set' %}
                    {% assign product_is_nail_set = true %}
                    {% break %}
                  {% endif %}
                {% endfor %}
                {% comment %} Only show badge if winter set is in cart {% endcomment %}
                {% assign show_badge = false %}
                {% if cart_has_winter_set and product_is_nail_set %}
                  {% assign show_badge = true %}
                {% endif %}
                <div
                  data-swiper-slide
                  data-block-id="{{ cs_product.id }}"
                  class="{% if line_items_ids contains cs_product.id %}hidden {% endif %}"
                >
                  {% render 'shoppable-product-card',
                    product: cs_product,
                    customClass: 'shoppable-product-card--cross-sell',
                    hide_brand: hide_brand,
                    show_upsell_badge: show_badge
                  %}
                </div>
              {% endfor %}
            </div>
            <div class="swiper-button-next wt-slider__nav-btn wt-slider__nav-next wt-slider__nav-next--featured">
              {% render 'icons', id: 'arrow-right' %}
            </div>
            <div class="swiper-button-prev wt-slider__nav-btn wt-slider__nav-prev wt-slider__nav-prev--featured">
              {% render 'icons', id: 'arrow-left' %}
            </div>
          </div>
          <script data-swiper-configuration type="text/json">
            {
              "slidesPerView": "auto",
              "spaceBetween": 0,
              "freeMode": false,
              "speed": 150,
              "grabCursor": true,
              "centeredSlides": false,
              "loop": false,
              "slideToClickedSlide": true,
              "enableOnMedia": "(min-width: 0px)",
              "pagination": false,
              "breakpoints": {
                "400": {
                  "slidesPerView": "auto"
                }
              },
              "navigation": {
                "nextEl": ".wt-slider__nav-next--featured",
                "prevEl": ".wt-slider__nav-prev--featured"
              }
            }
          </script>
        </slideshow-section>
      {% else %}
        {% for cs_product in cross_sell_products %}
          {% unless line_items_ids contains cs_product.id %}
            {% comment %} Check if this product is a nail set (eligible for $10 off) {% endcomment %}
            {% assign product_is_nail_set = false %}
            {% for tag in cs_product.tags %}
              {% assign tag_downcase = tag | downcase %}
              {% if tag_downcase == 'nail-set' or tag_downcase == 'nail sets' or tag_downcase == 'nail set' %}
                {% assign product_is_nail_set = true %}
                {% break %}
              {% endif %}
            {% endfor %}
            {% comment %} Only show badge if winter set is in cart {% endcomment %}
            {% assign show_badge = false %}
            {% if cart_has_winter_set and product_is_nail_set %}
              {% assign show_badge = true %}
            {% endif %}
            {% render 'shoppable-product-card',
              product: cs_product,
              customClass: 'shoppable-product-card--cross-sell shoppable-product-card--full',
              hide_brand: hide_brand,
              show_upsell_badge: show_badge
            %}
          {% endunless %}
        {% endfor %}
      {% endif %}
    </div>
  </div>
{% endif %}
