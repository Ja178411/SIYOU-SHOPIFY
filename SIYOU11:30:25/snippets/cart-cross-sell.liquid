{{ 'section-shoppable-video.css' | asset_url | stylesheet_tag }}
{{ 'shoppable-image.css' | asset_url | stylesheet_tag }}

{% assign line_items_ids = '' %}
{% for line_item in cart.items %}
  {% assign line_items_ids = line_items_ids | append: line_item.product_id | append: ', ' %}
{% endfor %}

{% comment %} Detect nail sets in cart by tag for upsell offer {% endcomment %}
{% assign cart_has_nail_set = false %}
{% assign upsell_nail_set_count = 0 %}
{% assign upsell_tag = settings.upsell_product_tag | default: 'upsell-trigger' | downcase %}
{% for item in cart.items %}
  {% for tag in item.product.tags %}
    {% assign tag_downcase = tag | downcase %}
    {% if tag_downcase == upsell_tag %}
      {% assign cart_has_nail_set = true %}
      {% assign upsell_nail_set_count = upsell_nail_set_count | plus: item.quantity %}
      {% break %}
    {% endif %}
  {% endfor %}
{% endfor %}

{% assign limit_products = settings.product_limit_cross_sells %}

{% assign hide_brand = true %}
{% if settings.show_vendor %}
  {% assign hide_brand = false %}
{% endif %}

{% comment %} default value is collection {% endcomment %}
{% assign cross_sell_products = settings.collection_cross_sells.products %}
{% assign cross_sell_size = 0 %}

{% assign product_source = settings.product_source_cross_sells %}

{% if product_source == 'product_list' %}
  {% assign cross_sell_products = settings.product_list_cross_sells %}
{% endif %}

{% for cs_product in cross_sell_products %}
  {% unless line_items_ids contains cs_product.id %}
    {% assign cross_sell_size = cross_sell_size | plus: 1 %}
  {% endunless %}
{% endfor %}

{% if cross_sell_size == 0 %}
  {% if request.design_mode %}
    <div class="wt-cart__cross-sell wt-cart__cross-sell--empty">
      <p class="wt-cart__cross-sell__heading">
        {{ settings.heading_cross_sells }}
      </p>
      <p class="wt-cart__cross-sell__empty">{{ 'cross_sell.empty_msg' | t }}</p>
    </div>
  {% endif %}
{% else %}
  <div class="wt-cart__cross-sell {% if settings.cross_sells_collapsed %}wt-cart__cross-sell--collapsed{% endif %}">
    <p class="wt-cart__cross-sell__heading">
      {{ settings.heading_cross_sells }}
      <span
        class="wt-cart__cross-sell__toggle"
        onclick="this.closest('.wt-cart__cross-sell').classList.toggle('wt-cart__cross-sell--collapsed')"
      >
        {% render 'icons', id: 'arrow-down' %}
      </span>
    </p>

    {% comment %} Enhanced Upsell banner - shows when nail set is in cart {% endcomment %}
    {% if settings.enable_upsell_offer and cart_has_nail_set %}
      <div class="upsell-banner" style="background: {{ settings.upsell_banner_background | default: 'linear-gradient(135deg, #ff9cb5 0%, #fc809f 100%)' }};">
        <div class="upsell-banner__content">
          <div class="upsell-banner__header">
            <span class="upsell-banner__icon">{{ settings.upsell_icon | default: 'üéÅ' }}</span>
            <h4 class="upsell-banner__title">
              {% if upsell_nail_set_count >= 2 %}
                You're saving $10! üéâ
              {% else %}
                {{ settings.upsell_banner_text | default: 'Add another nail set & save $10!' }}
              {% endif %}
            </h4>
          </div>
          
          <div class="upsell-banner__progress">
            <div class="upsell-banner__progress-bar">
              <div class="upsell-banner__progress-fill" style="width: {% if upsell_nail_set_count >= 2 %}100{% else %}50{% endif %}%;"></div>
            </div>
            <span class="upsell-banner__progress-text">
              {{ upsell_nail_set_count }} of 2 nail sets
            </span>
          </div>
          
          <p class="upsell-banner__subtitle">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            {% if upsell_nail_set_count >= 2 %}
              Discount will apply at checkout
            {% else %}
              Add 1 more to unlock your discount
            {% endif %}
          </p>
        </div>
      </div>
    {% endif %}

    <div class="wt-cart__cross-sell__products">
      {% if cross_sell_size > 1 %}
        <script type="module" src="{{ 'slider.js' | asset_url }}" defer="defer"></script>
        <slideshow-section class="wt-slider wt-slider--cross-sell" data-skip-center-nav-method="true">
          <div data-swiper class="wt-slider__container" data-sound="off">
            <div data-swiper-container class="video-reels__container">
              {% for cs_product in cross_sell_products limit: limit_products %}
                {% comment %} Check if this product has the upsell tag {% endcomment %}
                {% assign product_is_nail_set = false %}
                {% for tag in cs_product.tags %}
                  {% assign tag_downcase = tag | downcase %}
                  {% if tag_downcase == upsell_tag %}
                    {% assign product_is_nail_set = true %}
                    {% break %}
                  {% endif %}
                {% endfor %}
                <div
                  data-swiper-slide
                  data-block-id="{{ cs_product.id }}"
                  class="{% if line_items_ids contains cs_product.id %}hidden {% endif %}"
                >
                  {% render 'shoppable-product-card',
                    product: cs_product,
                    customClass: 'shoppable-product-card--cross-sell',
                    hide_brand: hide_brand,
                    show_upsell_badge: product_is_nail_set
                  %}
                </div>
              {% endfor %}
            </div>
            <div class="swiper-button-next wt-slider__nav-btn wt-slider__nav-next wt-slider__nav-next--featured">
              {% render 'icons', id: 'arrow-right' %}
            </div>
            <div class="swiper-button-prev wt-slider__nav-btn wt-slider__nav-prev wt-slider__nav-prev--featured">
              {% render 'icons', id: 'arrow-left' %}
            </div>
          </div>
          <script data-swiper-configuration type="text/json">
            {
              "slidesPerView": "auto",
              "spaceBetween": 0,
              "freeMode": false,
              "speed": 150,
              "grabCursor": true,
              "centeredSlides": false,
              "loop": false,
              "slideToClickedSlide": true,
              "enableOnMedia": "(min-width: 0px)",
              "pagination": false,
              "breakpoints": {
                "400": {
                  "slidesPerView": "auto"
                }
              },
              "navigation": {
                "nextEl": ".wt-slider__nav-next--featured",
                "prevEl": ".wt-slider__nav-prev--featured"
              }
            }
          </script>
        </slideshow-section>
      {% else %}
        {% for cs_product in cross_sell_products %}
          {% unless line_items_ids contains cs_product.id %}
            {% comment %} Check if this product has the upsell tag {% endcomment %}
            {% assign product_is_nail_set = false %}
            {% for tag in cs_product.tags %}
              {% assign tag_downcase = tag | downcase %}
              {% if tag_downcase == upsell_tag %}
                {% assign product_is_nail_set = true %}
                {% break %}
              {% endif %}
            {% endfor %}
            {% render 'shoppable-product-card',
              product: cs_product,
              customClass: 'shoppable-product-card--cross-sell shoppable-product-card--full',
              hide_brand: hide_brand,
              show_upsell_badge: product_is_nail_set
            %}
          {% endunless %}
        {% endfor %}
      {% endif %}
    </div>
  </div>
{% endif %}
